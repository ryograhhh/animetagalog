<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Tagalog - Watch</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .episode-btn {
            background-color: #f0f0f0;
            color: #333;
            transition: all 0.2s ease;
            text-align: center;
            border-radius: 2px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .episode-btn:hover {
            background-color: #e5e5e5;
        }
        .episode-btn.active {
            background-color: #6766eb;
            color: white;
        }
        .episode-btn.current {
            background-color: #536e55;
            color: white;
        }
        .plyr {
            border-radius: 4px;
            overflow: hidden;
        }
        .control-btn {
            background-color: #f0f0f0;
            color: #333;
            padding: 5px 10px;
            border-radius: 2px;
            font-size: 12px;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }
        .control-btn:hover {
            background-color: #e5e5e5;
        }
        .control-btn.active {
            background-color: #ffc107;
            color: #333;
        }
        .header-icon-btn {
            background-color: #f0f0f0;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 4px;
        }
        .header-icon-btn:hover {
            background-color: #e5e5e5;
        }
        .dropdown-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px 16px;
            padding-right: 32px;
        }
        .episode-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
        }
        @media (min-width: 640px) {
            .episode-grid {
                grid-template-columns: repeat(8, 1fr);
            }
        }
        .anime-info-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        /* For better responsiveness */
        @media (max-width: 640px) {
            .control-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
            .header-icon-btn {
                width: 36px;
                height: 36px;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <div class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <a href="index.html" class="text-2xl font-bold flex items-center text-black">
                    ANIME TAGALOG<span class="text-blue-600 text-lg">tv</span>
                </a>
                <div class="flex space-x-2">
                    <a href="#" class="header-icon-btn">
                        <i data-feather="search" class="h-5 w-5"></i>
                    </a>
                    <a href="#" class="header-icon-btn">
                        <i data-feather="download-cloud" class="h-5 w-5"></i>
                    </a>
                    <a href="#" class="header-icon-btn">
                        <i data-feather="user" class="h-5 w-5"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4">
        <!-- Video Player Section -->
        <div id="videoSection" class="mb-4">
            <!-- Video thumbnail (shown before video loads) -->
            <div id="videoThumbnail" class="relative">
                <img src="/api/placeholder/800/450" alt="Video Thumbnail" class="w-full h-auto rounded-sm">
                <div class="absolute inset-0 flex items-center justify-center">
                    <button id="playThumbnail" class="bg-gray-800 bg-opacity-70 text-white p-4 rounded-full hover:bg-opacity-80 transition">
                        <i data-feather="play" class="h-8 w-8"></i>
                    </button>
                </div>
                <div class="absolute bottom-4 right-4 bg-black bg-opacity-70 text-white px-2 py-1 rounded">
                    <span id="videoDuration">23:37</span>
                </div>
            </div>
            
            <!-- Video player (hidden initially) -->
            <div id="videoPlayerContainer" class="hidden">
                <video id="player" playsinline controls class="w-full">
                    <source id="videoSource" src="" type="video/mp4">
                </video>
            </div>
        </div>

        <!-- Player Controls -->
        <div class="bg-white shadow-sm p-2 mb-3">
            <div class="flex flex-wrap items-center gap-2">
                <label class="inline-flex items-center">
                    <input type="checkbox" id="autoplayToggle" class="form-checkbox h-4 w-4">
                    <span class="text-xs text-gray-700 ml-1">Autoplay</span>
                </label>
                
                <button id="autoNextBtn" class="control-btn text-xs">
                    <span class="text-yellow-500 font-bold">Auto</span>
                    <span class="ml-1">Next</span>
                </button>
                
                <button id="prevEpisodeBtn" class="control-btn text-xs">
                    <i data-feather="chevron-left" class="h-3 w-3 mr-1"></i> Prev
                </button>
                
                <button id="nextEpisodeBtn" class="control-btn text-xs">
                    Next <i data-feather="chevron-right" class="h-3 w-3 ml-1"></i>
                </button>
            </div>
        </div>
        
        <!-- Episode Selector -->
        <div class="bg-white shadow-sm p-3 mb-3">
            <div class="flex items-center justify-between mb-2">
                <select id="episodeRangeSelect" class="dropdown-select bg-gray-100 border-0 rounded-sm py-2 px-3 text-xs text-gray-700 focus:outline-none mr-2">
                    <option value="1-100">EPS 1 - 100</option>
                    <option value="101-148">EPS 101 - 148</option>
                </select>
                
                <div class="flex-1 mr-2">
                    <div class="relative">
                        <input type="text" placeholder="Filter episodes..." id="filterEpisodes" class="w-full bg-gray-100 border-0 rounded-sm py-2 px-3 text-xs text-gray-700 focus:outline-none">
                        <div class="absolute right-0 top-0 h-full flex items-center pr-2">
                            <button id="viewListBtn" class="text-gray-500 hover:text-gray-700 p-1">
                                <i data-feather="list" class="h-4 w-4"></i>
                            </button>
                            <button id="viewGridBtn" class="text-gray-500 hover:text-gray-700 p-1">
                                <i data-feather="grid" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Episode Grid -->
            <div id="episodeGrid" class="episode-grid">
                <!-- This will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Anime Info Section -->
        <div class="bg-white shadow-sm rounded-sm p-4 mb-3">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Anime Image -->
                <div class="w-full md:w-1/4 lg:w-1/6">
                    <img id="animeImage" src="/api/placeholder/300/450" alt="Anime Cover" class="w-full h-auto object-cover rounded-sm">
                </div>
                
                <!-- Anime Details -->
                <div class="flex-1">
                    <h1 id="animeTitle" class="text-xl font-bold mb-2">Anime Title</h1>
                    
                    <div id="animeInfo" class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3 text-sm">
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">Type:</span>
                            <span id="animeType" class="font-medium">TV</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">Status:</span>
                            <span id="animeStatus" class="font-medium">Ongoing</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">Episodes:</span>
                            <span id="animeEpisodes" class="font-medium">24</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">Year:</span>
                            <span id="animeYear" class="font-medium">2023</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-20">Rating:</span>
                            <span id="animeRating" class="font-medium flex items-center">
                                <span class="text-yellow-500 mr-1">★</span> 8.7
                            </span>
                        </div>
                    </div>
                    
                    <!-- Genres -->
                    <div class="mb-3">
                        <div id="animeGenres" class="flex flex-wrap">
                            <span class="anime-info-tag bg-blue-100 text-blue-800">Action</span>
                            <span class="anime-info-tag bg-green-100 text-green-800">Adventure</span>
                            <span class="anime-info-tag bg-purple-100 text-purple-800">Fantasy</span>
                        </div>
                    </div>
                    
                    <!-- Synopsis -->
                    <div>
                        <h3 class="text-sm font-semibold mb-1">Synopsis</h3>
                        <p id="animeSynopsis" class="text-sm text-gray-600">
                            The anime synopsis will be displayed here. This provides a summary of the anime's plot and setting.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Episode Information -->
        <div class="bg-white shadow-sm p-3 mb-6">
            <h2 id="episodeTitle" class="text-lg font-semibold mb-1">Episode 1</h2>
            <div class="mb-2 flex items-center text-xs text-gray-500">
                <span id="episodeDate">October 21, 2023</span>
                <span class="mx-2">•</span>
                <button class="flex items-center hover:text-gray-900">
                    <i data-feather="download" class="h-3 w-3 mr-1"></i> Download
                </button>
                <span class="mx-2">•</span>
                <button class="flex items-center hover:text-gray-900">
                    <i data-feather="share-2" class="h-3 w-3 mr-1"></i> Share
                </button>
            </div>
            <p id="episodeDescription" class="text-sm text-gray-600 mb-2">
                Episode description will appear here. This provides information about the current episode's content.
            </p>
            
            <div class="text-xs text-yellow-600 flex items-center mt-2">
                <i data-feather="alert-circle" class="h-3 w-3 mr-1"></i>
                If the player doesn't work or keeps buffering, try refreshing the page.
            </div>
        </div>
    </div>

    <script>
        let player;
        let currentAnime = null;
        let currentEpisode = 1;
        let allEpisodes = [];
        let autoplayEnabled = localStorage.getItem('autoplayEnabled') === 'true';
        let autoNextEnabled = localStorage.getItem('autoNextEnabled') === 'true';
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            
            // Get anime ID and episode from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const animeId = urlParams.get('id');
            const episodeParam = urlParams.get('ep');
            
            if (animeId) {
                loadAnimeDetails(animeId);
                
                if (episodeParam && !isNaN(episodeParam)) {
                    currentEpisode = parseInt(episodeParam);
                }
            } else {
                showError('No anime selected. Please select an anime from the home page.');
            }
            
            // Setup UI elements and event listeners
            document.getElementById('autoplayToggle').checked = autoplayEnabled;
            if (autoNextEnabled) {
                document.getElementById('autoNextBtn').classList.add('active');
            }
            
            setupEventListeners();
            
            // Generate initial episode grid
            generateEpisodeGrid(1, 100);
        });

        // Load anime details
        function loadAnimeDetails(animeId) {
            fetch(`/api/animes/${animeId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    currentAnime = data;
                    document.title = `${data.title} - Anime Tagalog`;
                    
                    // Update anime info
                    document.getElementById('animeTitle').textContent = data.title || 'Unknown Title';
                    document.getElementById('animeImage').src = data.poster || '/api/placeholder/300/450';
                    document.getElementById('animeImage').alt = data.title || 'Anime Cover';
                    document.getElementById('animeType').textContent = data.type || 'TV';
                    document.getElementById('animeStatus').textContent = data.status || 'Unknown';
                    document.getElementById('animeEpisodes').textContent = data.episodes || '0';
                    document.getElementById('animeYear').textContent = data.year || 'Unknown';
                    
                    // Format rating
                    const rating = parseFloat(data.rating || 0).toFixed(1);
                    document.getElementById('animeRating').innerHTML = `<span class="text-yellow-500 mr-1">★</span> ${rating}`;
                    
                    // Update genres
                    const genresContainer = document.getElementById('animeGenres');
                    genresContainer.innerHTML = '';
                    
                    if (data.genres && data.genres.length > 0) {
                        const colors = [
                            'bg-blue-100 text-blue-800',
                            'bg-green-100 text-green-800',
                            'bg-purple-100 text-purple-800',
                            'bg-red-100 text-red-800',
                            'bg-yellow-100 text-yellow-800',
                            'bg-indigo-100 text-indigo-800',
                            'bg-pink-100 text-pink-800'
                        ];
                        
                        data.genres.forEach((genre, index) => {
                            const colorClass = colors[index % colors.length];
                            const genreTag = document.createElement('span');
                            genreTag.className = `anime-info-tag ${colorClass}`;
                            genreTag.textContent = genre;
                            genresContainer.appendChild(genreTag);
                        });
                    } else {
                        genresContainer.innerHTML = '<span class="text-gray-500 text-sm">No genres listed</span>';
                    }
                    
                    // Update synopsis
                    document.getElementById('animeSynopsis').textContent = data.synopsis || 'No synopsis available.';
                    
                    // Set video thumbnail
                    const thumbnail = data.poster || '/api/placeholder/800/450';
                    document.getElementById('videoThumbnail').querySelector('img').src = thumbnail;
                    
                    loadEpisodes(animeId);
                    updateEpisodeRangeOptions(data.episodes || 100);
                })
                .catch(error => {
                    console.error('Error loading anime details:', error);
                    showError('Failed to load anime details');
                });
        }

        // Load episodes
        function loadEpisodes(animeId) {
            fetch(`/api/animes/${animeId}/episodes`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    allEpisodes = data;
                    updateEpisodeInfo(currentEpisode);
                })
                .catch(error => {
                    console.error('Error loading episodes:', error);
                });
        }

        // Update episode information
        function updateEpisodeInfo(episodeNumber) {
            const episode = allEpisodes.find(ep => ep.episodeNumber === episodeNumber);
            
            // Set default values
            document.getElementById('episodeTitle').textContent = `Episode ${episodeNumber}`;
            document.getElementById('episodeDescription').textContent = 'No description available for this episode.';
            document.getElementById('episodeDate').textContent = 'Unknown date';
            
            // Update with actual data if available
            if (episode) {
                if (episode.title) {
                    document.getElementById('episodeTitle').textContent = `Episode ${episodeNumber}: ${episode.title}`;
                }
                
                if (episode.description) {
                    document.getElementById('episodeDescription').textContent = episode.description;
                }
                
                if (episode.dateAdded) {
                    const date = new Date(episode.dateAdded);
                    document.getElementById('episodeDate').textContent = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Play thumbnail button
            document.getElementById('playThumbnail').addEventListener('click', function() {
                document.getElementById('videoThumbnail').classList.add('hidden');
                document.getElementById('videoPlayerContainer').classList.remove('hidden');
                initializeVideoPlayer();
                loadEpisodeVideo(currentEpisode);
            });
            
            // Autoplay toggle
            document.getElementById('autoplayToggle').addEventListener('change', function() {
                autoplayEnabled = this.checked;
                localStorage.setItem('autoplayEnabled', autoplayEnabled);
            });
            
            // Auto Next button
            document.getElementById('autoNextBtn').addEventListener('click', function() {
                autoNextEnabled = !autoNextEnabled;
                this.classList.toggle('active');
                localStorage.setItem('autoNextEnabled', autoNextEnabled);
            });
            
            // Previous episode button
            document.getElementById('prevEpisodeBtn').addEventListener('click', function() {
                if (currentEpisode > 1) {
                    navigateToEpisode(currentEpisode - 1);
                }
            });
            
            // Next episode button
            document.getElementById('nextEpisodeBtn').addEventListener('click', function() {
                if (currentAnime && currentEpisode < currentAnime.episodes) {
                    navigateToEpisode(currentEpisode + 1);
                }
            });
            
            // Episode range select
            document.getElementById('episodeRangeSelect').addEventListener('change', function() {
                const [start, end] = this.value.split('-').map(Number);
                generateEpisodeGrid(start, end);
            });
            
            // Episode filter
            document.getElementById('filterEpisodes').addEventListener('input', function() {
                const filterText = this.value.trim();
                filterEpisodes(filterText);
            });
            
            // View buttons (list/grid)
            document.getElementById('viewListBtn').addEventListener('click', function() {
                const grid = document.getElementById('episodeGrid');
                grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            });
            
            document.getElementById('viewGridBtn').addEventListener('click', function() {
                const grid = document.getElementById('episodeGrid');
                
                if (window.innerWidth >= 640) {
                    grid.style.gridTemplateColumns = 'repeat(8, 1fr)';
                } else {
                    grid.style.gridTemplateColumns = 'repeat(4, 1fr)';
                }
            });
        }

        // Initialize video player
        function initializeVideoPlayer() {
            player = new Plyr('#player', {
                controls: [
                    'play-large', 'play', 'progress', 'current-time', 'mute',
                    'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                ]
            });
            
            // Handle auto-next when video ends
            player.on('ended', function() {
                if (autoNextEnabled && currentAnime && currentEpisode < currentAnime.episodes) {
                    navigateToEpisode(currentEpisode + 1);
                }
            });
        }

        // Load episode video
        function loadEpisodeVideo(episodeNumber) {
            if (!currentAnime) return;
            
            const videoUrl = `/api/animes/${currentAnime.id}/episodes/${episodeNumber}/server/1`;
            
            // Update video source
            if (player) {
                player.source = {
                    type: 'video',
                    sources: [
                        {
                            src: videoUrl,
                            type: 'video/mp4'
                        }
                    ]
                };
                
                // Autoplay if enabled
                if (autoplayEnabled) {
                    setTimeout(() => player.play(), 300);
                }
            } else {
                // If player not initialized yet
                document.getElementById('videoSource').src = videoUrl;
            }
            
            // Update episode info
            updateEpisodeInfo(episodeNumber);
        }

        // Navigate to episode
        function navigateToEpisode(episodeNumber) {
            // Update current episode
            currentEpisode = episodeNumber;
            
            // Update URL without reloading page
            const url = new URL(window.location);
            url.searchParams.set('ep', episodeNumber);
            window.history.pushState({}, '', url);
            
            // Load the video
            loadEpisodeVideo(episodeNumber);
            
            // Update episode grid (highlight current episode)
            updateEpisodeGridSelection();
            
            // Make sure current episode is visible in range
            ensureEpisodeInRange(episodeNumber);
        }

        // Generate episode grid
        function generateEpisodeGrid(start, end) {
            const grid = document.getElementById('episodeGrid');
            grid.innerHTML = '';
            
            for (let i = start; i <= end; i++) {
                const button = document.createElement('button');
                button.className = 'episode-btn';
                button.textContent = i;
                
                // Mark current episode
                if (i === currentEpisode) {
                    button.classList.add('active');
                }
                
                // Handle click
                button.addEventListener('click', function() {
                    navigateToEpisode(i);
                });
                
                grid.appendChild(button);
            }
        }

        // Update episode grid selection
        function updateEpisodeGridSelection() {
            const buttons = document.querySelectorAll('.episode-btn');
            buttons.forEach(button => {
                const episodeNum = parseInt(button.textContent);
                if (episodeNum === currentEpisode) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        // Filter episodes
        function filterEpisodes(filterText) {
            if (!filterText) {
                // Show all episodes
                document.querySelectorAll('.episode-btn').forEach(btn => {
                    btn.style.display = '';
                });
                return;
            }
            
            // Filter by number
            const filterNum = parseInt(filterText);
            document.querySelectorAll('.episode-btn').forEach(btn => {
                const btnNum = parseInt(btn.textContent);
                if (isNaN(filterNum) || btnNum.toString().includes(filterText)) {
                    btn.style.display = '';
                } else {
                    btn.style.display = 'none';
                }
            });
        }

        // Update episode range options
        function updateEpisodeRangeOptions(totalEpisodes) {
            const select = document.getElementById('episodeRangeSelect');
            select.innerHTML = '';
            
            // Create options in batches of 100 (or less for the last batch)
            for (let i = 1; i <= totalEpisodes; i += 100) {
                const end = Math.min(i + 99, totalEpisodes);
                const option = document.createElement('option');
                option.value = `${i}-${end}`;
                option.textContent = `EPS ${i} - ${end}`;
                select.appendChild(option);
            }
            
            // Ensure current episode is in range
            ensureEpisodeInRange(currentEpisode);
        }

        // Make sure the episode is in the current range
        function ensureEpisodeInRange(episodeNumber) {
            const select = document.getElementById('episodeRangeSelect');
            
            // Find the range containing the episode
            for (let i = 0; i < select.options.length; i++) {
                const [start, end] = select.options[i].value.split('-').map(Number);
                
                if (episodeNumber >= start && episodeNumber <= end) {
                    // Select this range if not already selected
                    if (select.selectedIndex !== i) {
                        select.selectedIndex = i;
                        generateEpisodeGrid(start, end);
                    }
                    break;
                }
            }
        }

        // Show error message
        function showError(message) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="mt-6 p-4 bg-white shadow-sm rounded-sm">
                    <div class="flex flex-col items-center p-6 text-center">
                        <i data-feather="alert-circle" class="text-red-500 h-12 w-12 mb-4"></i>
                        <h3 class="text-lg font-medium text-red-800 mb-2">Error</h3>
                        <p class="text-gray-600 mb-4">${message}</p>
                        <a href="index.html" class="px-4 py-2 bg-indigo-600 text-white rounded-sm">
                            Return to Home
                        </a>
                    </div>
                </div>
            `;
            feather.replace();
        }
    </script>
</body>
</html>
