<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Tagalog - Watch</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .episode-btn {
            background-color: #f0f0f0;
            color: #333;
            transition: all 0.2s ease;
            text-align: center;
            border-radius: 4px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .episode-btn:hover {
            background-color: #e5e5e5;
        }
        .episode-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .episode-btn.current {
            background-color: #536e55;
            color: white;
        }
        .plyr {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .control-btn {
            background-color: #f0f0f0;
            color: #333;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }
        .control-btn:hover {
            background-color: #e5e5e5;
        }
        .control-btn.active {
            background-color: #4f46e5;
            color: white;
        }
        .dropdown-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px 16px;
            padding-right: 32px;
        }
        .episode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
        }
        @media (min-width: 640px) {
            .episode-grid {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            }
        }
        .anime-info-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        /* For better responsiveness */
        @media (max-width: 640px) {
            .control-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
        }
        /* Improved player styles */
        .plyr--video {
            border-radius: 8px;
            overflow: hidden;
        }
        .plyr__control--overlaid {
            background: rgba(79, 70, 229, 0.8);
        }
        .plyr--full-ui input[type=range] {
            color: #4f46e5;
        }
        .plyr__control.plyr__tab-focus,
        .plyr__control:hover,
        .plyr__control[aria-expanded=true] {
            background: #4f46e5;
        }
        .plyr__menu__container .plyr__control[role=menuitemradio][aria-checked=true]::before {
            background: #4f46e5;
        }
        /* Loading spinner */
        .loader {
            border-top-color: #4f46e5;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Simple Header -->
    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <a href="index.html" class="text-lg font-bold text-indigo-600 flex items-center">
                    <i data-feather="arrow-left" class="h-5 w-5 mr-2"></i>
                    ANIME TAGALOG
                </a>
                <div class="flex gap-2">
                    <button id="shareButton" class="text-gray-500 hover:text-indigo-600 flex items-center text-sm">
                        <i data-feather="share-2" class="h-4 w-4 mr-1"></i>
                        <span class="hidden sm:inline">Share</span>
                    </button>
                    <button id="downloadButton" class="text-gray-500 hover:text-indigo-600 flex items-center text-sm">
                        <i data-feather="download" class="h-4 w-4 mr-1"></i>
                        <span class="hidden sm:inline">Download</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4 max-w-4xl">
        <!-- Video Player Section -->
        <div id="videoSection" class="mb-4">
            <!-- Video thumbnail (shown before video loads) -->
            <div id="videoThumbnail" class="relative rounded-lg overflow-hidden shadow-lg">
                <img src="/api/placeholder/800/450" alt="Video Thumbnail" class="w-full h-auto object-cover">
                <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30">
                    <button id="playThumbnail" class="bg-indigo-600 text-white p-4 rounded-full hover:bg-indigo-700 transition transform hover:scale-105">
                        <i data-feather="play" class="h-8 w-8"></i>
                    </button>
                </div>
                <div class="absolute bottom-4 right-4 bg-black bg-opacity-70 text-white px-3 py-1 rounded-full text-sm font-medium">
                    <span id="videoDuration">Loading...</span>
                </div>
                <div class="absolute top-4 left-4 bg-indigo-600 text-white px-3 py-1 rounded-full text-sm font-medium">
                    <span id="episodeLabel">Episode 1</span>
                </div>
            </div>
            
            <!-- Video player (hidden initially) -->
            <div id="videoPlayerContainer" class="hidden">
                <video id="player" playsinline controls class="w-full rounded-lg shadow-lg">
                    <source id="videoSource" src="" type="video/mp4">
                    <!-- Fallback for old browsers -->
                    <p>Your browser doesn't support HTML5 video. Here is a <a href="">link to the video</a> instead.</p>
                </video>
            </div>
        </div>

        <!-- Player Controls -->
        <div class="bg-white shadow-sm p-3 mb-3 rounded-lg">
            <div class="flex flex-wrap items-center justify-between gap-2">
                <div class="flex items-center gap-2">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="autoplayToggle" class="form-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-xs text-gray-700 ml-1">Autoplay</span>
                    </label>
                    
                    <button id="autoNextBtn" class="control-btn text-xs">
                        <i data-feather="skip-forward" class="h-3 w-3 mr-1"></i> Auto Next
                    </button>
                    
                    <div>
                        <select id="serverSelector" class="text-xs px-2 py-1 border rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="1">Server 1</option>
                            <option value="2">Server 2</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <button id="prevEpisodeBtn" class="control-btn text-xs">
                        <i data-feather="chevron-left" class="h-3 w-3 mr-1"></i> Prev
                    </button>
                    
                    <button id="nextEpisodeBtn" class="control-btn text-xs">
                        Next <i data-feather="chevron-right" class="h-3 w-3 ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Episode Selector -->
        <div class="bg-white shadow-sm p-3 mb-3 rounded-lg">
            <div class="flex flex-col md:flex-row md:items-center gap-2 mb-3">
                <select id="episodeRangeSelect" class="dropdown-select bg-gray-100 border-0 rounded-md py-2 px-3 text-xs text-gray-700 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                    <!-- Will be populated dynamically based on total episodes -->
                </select>
                
                <div class="relative flex-1">
                    <input type="text" placeholder="Filter episodes..." id="filterEpisodes" 
                          class="w-full bg-gray-100 border-0 rounded-md py-2 px-3 pr-16 text-xs text-gray-700 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                    <div class="absolute right-0 top-0 h-full flex items-center pr-2">
                        <button id="viewListBtn" class="text-gray-500 hover:text-indigo-600 p-1">
                            <i data-feather="list" class="h-4 w-4"></i>
                        </button>
                        <button id="viewGridBtn" class="text-gray-500 hover:text-indigo-600 p-1">
                            <i data-feather="grid" class="h-4 w-4"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Episode Grid -->
            <div id="episodeGrid" class="episode-grid">
                <!-- This will be populated by JavaScript -->
                <div class="col-span-full flex justify-center py-3">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8"></div>
                </div>
            </div>
        </div>
        
        <!-- Episode Information -->
        <div class="bg-white shadow-sm p-4 mb-3 rounded-lg">
            <h2 id="episodeTitle" class="text-lg font-semibold mb-1">Episode 1</h2>
            <div class="mb-2 flex flex-wrap items-center text-xs text-gray-500 gap-2">
                <span id="episodeDate">Loading...</span>
                <button id="episodeDownloadBtn" class="flex items-center hover:text-indigo-600 focus:outline-none">
                    <i data-feather="download" class="h-3 w-3 mr-1"></i> Download
                </button>
                <button id="episodeShareBtn" class="flex items-center hover:text-indigo-600 focus:outline-none">
                    <i data-feather="share-2" class="h-3 w-3 mr-1"></i> Share
                </button>
            </div>
            <p id="episodeDescription" class="text-sm text-gray-600 mb-3">
                Loading episode information...
            </p>
            
            <div class="text-xs text-yellow-600 flex items-center mt-2 bg-yellow-50 p-2 rounded-md">
                <i data-feather="alert-circle" class="h-3 w-3 mr-1"></i>
                If the player doesn't work or keeps buffering, try changing the server or refreshing the page.
            </div>
        </div>
        
        <!-- Anime Info Section -->
        <div class="bg-white shadow-sm rounded-lg p-4 mb-3">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Anime Image -->
                <div class="w-full md:w-1/4 lg:w-1/5">
                    <img id="animeImage" src="/api/placeholder/300/450" alt="Anime Cover" class="w-full h-auto object-cover rounded-lg shadow-sm">
                </div>
                
                <!-- Anime Details -->
                <div class="flex-1">
                    <h1 id="animeTitle" class="text-xl font-bold mb-2">Loading anime...</h1>
                    
                    <div id="animeInfo" class="grid grid-cols-2 sm:grid-cols-3 gap-y-2 gap-x-4 mb-4 text-sm">
                        <div class="flex items-center">
                            <span class="text-gray-500 w-16 sm:w-20">Status:</span>
                            <span id="animeStatus" class="font-medium">Loading...</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-16 sm:w-20">Episodes:</span>
                            <span id="animeEpisodes" class="font-medium">?</span>
                        </div>
                        <div class="flex items-center">
                            <span class="text-gray-500 w-16 sm:w-20">Year:</span>
                            <span id="animeYear" class="font-medium">Loading...</span>
                        </div>
                        <div class="flex items-center col-span-2 sm:col-span-1">
                            <span class="text-gray-500 w-16 sm:w-20">Rating:</span>
                            <span id="animeRating" class="font-medium flex items-center">
                                <span class="text-yellow-500 mr-1">★</span> ?
                            </span>
                        </div>
                    </div>
                    
                    <!-- Genres -->
                    <div class="mb-4">
                        <div id="animeGenres" class="flex flex-wrap">
                            <span class="anime-info-tag bg-gray-100 text-gray-500">Loading genres...</span>
                        </div>
                    </div>
                    
                    <!-- Synopsis -->
                    <div>
                        <h3 class="text-sm font-semibold mb-1">Synopsis</h3>
                        <p id="animeSynopsis" class="text-sm text-gray-600">
                            Loading anime synopsis...
                        </p>
                    </div>

                    <!-- Related Anime -->
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <h3 class="text-sm font-semibold mb-2">Related Anime</h3>
                        <div id="relatedAnime" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                            <div class="bg-gray-100 h-12 animate-pulse rounded-md"></div>
                            <div class="bg-gray-100 h-12 animate-pulse rounded-md"></div>
                            <div class="bg-gray-100 h-12 animate-pulse rounded-md"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let player;
        let currentAnime = null;
        let currentEpisode = 1;
        let currentServer = 1;
        let allEpisodes = [];
        let autoplayEnabled = localStorage.getItem('autoplayEnabled') === 'true';
        let autoNextEnabled = localStorage.getItem('autoNextEnabled') === 'true';
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            
            // Get anime ID and episode from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const animeId = urlParams.get('id');
            const episodeParam = urlParams.get('ep');
            
            if (animeId) {
                loadAnimeDetails(animeId);
                
                if (episodeParam && !isNaN(episodeParam)) {
                    currentEpisode = parseInt(episodeParam);
                }
                
                // Check if server parameter is present
                const serverParam = urlParams.get('server');
                if (serverParam && (serverParam === '1' || serverParam === '2')) {
                    currentServer = parseInt(serverParam);
                    document.getElementById('serverSelector').value = serverParam;
                }
            } else {
                showError('No anime selected. Please select an anime from the home page.');
            }
            
            // Setup UI elements and event listeners
            document.getElementById('autoplayToggle').checked = autoplayEnabled;
            if (autoNextEnabled) {
                document.getElementById('autoNextBtn').classList.add('active');
            }
            
            setupEventListeners();
            
            // Update episode label
            document.getElementById('episodeLabel').textContent = `Episode ${currentEpisode}`;
        });

        // Load anime details
        function loadAnimeDetails(animeId) {
            fetch(`/api/animes/${animeId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    currentAnime = data;
                    document.title = `${data.title} - Episode ${currentEpisode} - Anime Tagalog`;
                    
                    // Update anime info
                    document.getElementById('animeTitle').textContent = data.title || 'Unknown Title';
                    document.getElementById('animeImage').src = data.poster || '/api/placeholder/300/450';
                    document.getElementById('animeImage').alt = data.title || 'Anime Cover';
                    document.getElementById('animeStatus').textContent = data.status || 'Unknown';
                    document.getElementById('animeEpisodes').textContent = data.episodes || '0';
                    document.getElementById('animeYear').textContent = data.year || 'Unknown';
                    
                    // Format rating
                    const rating = parseFloat(data.rating || 0).toFixed(1);
                    document.getElementById('animeRating').innerHTML = `<span class="text-yellow-500 mr-1">★</span> ${rating}`;
                    
                    // Update genres
                    const genresContainer = document.getElementById('animeGenres');
                    genresContainer.innerHTML = '';
                    
                    if (data.genres && data.genres.length > 0) {
                        const colors = [
                            'bg-blue-100 text-blue-800',
                            'bg-green-100 text-green-800',
                            'bg-purple-100 text-purple-800',
                            'bg-red-100 text-red-800',
                            'bg-yellow-100 text-yellow-800',
                            'bg-indigo-100 text-indigo-800',
                            'bg-pink-100 text-pink-800'
                        ];
                        
                        data.genres.forEach((genre, index) => {
                            const colorClass = colors[index % colors.length];
                            const genreTag = document.createElement('span');
                            genreTag.className = `anime-info-tag ${colorClass}`;
                            genreTag.textContent = genre;
                            genresContainer.appendChild(genreTag);
                        });
                    } else {
                        genresContainer.innerHTML = '<span class="text-gray-500 text-sm">No genres listed</span>';
                    }
                    
                    // Update synopsis
                    document.getElementById('animeSynopsis').textContent = data.synopsis || 'No synopsis available.';
                    
                    // Set video thumbnail
                    const thumbnail = data.poster || '/api/placeholder/800/450';
                    document.getElementById('videoThumbnail').querySelector('img').src = thumbnail;
                    
                    // Load episodes and set up range options based on total count
                    loadEpisodes(animeId);
                    
                    // Create episode ranges based on actual episode count
                    const totalEpisodes = parseInt(data.episodes) || 0;
                    createEpisodeRanges(totalEpisodes);
                    
                    // Generate initial episode grid based on current episode
                    if (totalEpisodes > 0) {
                        let rangeStart = 1;
                        // Find the appropriate range for the current episode
                        if (currentEpisode > 24) {
                            rangeStart = Math.floor((currentEpisode - 1) / 24) * 24 + 1;
                        }
                        const rangeEnd = Math.min(rangeStart + 23, totalEpisodes);
                        generateEpisodeGrid(rangeStart, rangeEnd);
                    }
                    
                    // Load related anime
                    loadRelatedAnime(animeId);
                })
                .catch(error => {
                    console.error('Error loading anime details:', error);
                    showError('Failed to load anime details');
                });
        }
        
        // Load related anime
        function loadRelatedAnime(animeId) {
            fetch(`/api/animes/${animeId}/related`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(related => {
                    const container = document.getElementById('relatedAnime');
                    container.innerHTML = '';
                    
                    if (!related || related.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-sm col-span-full">No related anime found</p>';
                        return;
                    }
                    
                    related.forEach(anime => {
                        const card = document.createElement('a');
                        card.href = `watch.html?id=${anime.id}`;
                        card.className = 'flex items-center p-2 bg-gray-50 hover:bg-gray-100 rounded-md transition';
                        
                        card.innerHTML = `
                            <img src="${anime.poster || '/api/placeholder/60/90'}" alt="${anime.title}" class="h-10 w-6 object-cover mr-2 rounded">
                            <span class="text-xs font-medium truncate">${anime.title}</span>
                        `;
                        
                        container.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error loading related anime:', error);
                    const container = document.getElementById('relatedAnime');
                    container.innerHTML = '<p class="text-gray-500 text-sm col-span-full">Could not load related anime</p>';
                });
        }

        // Create episode range options based on total episodes
        function createEpisodeRanges(totalEpisodes) {
            const select = document.getElementById('episodeRangeSelect');
            select.innerHTML = '';
            
            if (totalEpisodes <= 0) {
                const option = document.createElement('option');
                option.value = '0-0';
                option.textContent = 'No Episodes';
                select.appendChild(option);
                return;
            }
            
            // Create ranges in batches of 24 episodes
            for (let i = 1; i <= totalEpisodes; i += 24) {
                const end = Math.min(i + 23, totalEpisodes);
                const option = document.createElement('option');
                option.value = `${i}-${end}`;
                option.textContent = `EPS ${i} - ${end}`;
                select.appendChild(option);
            }
            
            // Make sure the range containing the current episode is selected
            setSelectedRange(currentEpisode);
        }

        // Set the selected range based on episode number
        function setSelectedRange(episodeNumber) {
            const select = document.getElementById('episodeRangeSelect');
            
            for (let i = 0; i < select.options.length; i++) {
                const [start, end] = select.options[i].value.split('-').map(Number);
                
                if (episodeNumber >= start && episodeNumber <= end) {
                    select.selectedIndex = i;
                    break;
                }
            }
        }

        // Load episodes
        function loadEpisodes(animeId) {
            fetch(`/api/animes/${animeId}/episodes`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    allEpisodes = data;
                    updateEpisodeInfo(currentEpisode);
                })
                .catch(error => {
                    console.error('Error loading episodes:', error);
                });
        }

        // Update episode information
        function updateEpisodeInfo(episodeNumber) {
            const episode = allEpisodes.find(ep => ep.episodeNumber === episodeNumber);
            
            // Set default values
            document.getElementById('episodeTitle').textContent = `Episode ${episodeNumber}`;
            document.getElementById('episodeDescription').textContent = 'No description available for this episode.';
            document.getElementById('episodeDate').textContent = 'Unknown date';
            document.getElementById('episodeLabel').textContent = `Episode ${episodeNumber}`;
            
            // Update with actual data if available
            if (episode) {
                if (episode.title) {
                    document.getElementById('episodeTitle').textContent = `Episode ${episodeNumber}: ${episode.title}`;
                }
                
                if (episode.description) {
                    document.getElementById('episodeDescription').textContent = episode.description;
                }
                
                if (episode.dateAdded) {
                    const date = new Date(episode.dateAdded);
                    document.getElementById('episodeDate').textContent = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
                
                // Enable or disable download button based on whether a source is available
                const downloadBtn = document.getElementById('episodeDownloadBtn');
                const downloadButton = document.getElementById('downloadButton');
                
                if (episode.sources && (episode.sources.server1 || episode.sources.server2)) {
                    downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    downloadBtn.disabled = false;
                    downloadButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    downloadButton.disabled = false;
                } else {
                    downloadBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    downloadBtn.disabled = true;
                    downloadButton.classList.add('opacity-50', 'cursor-not-allowed');
                    downloadButton.disabled = true;
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Play thumbnail button
            document.getElementById('playThumbnail').addEventListener('click', function() {
                document.getElementById('videoThumbnail').classList.add('hidden');
                document.getElementById('videoPlayerContainer').classList.remove('hidden');
                initializeVideoPlayer();
                loadEpisodeVideo(currentEpisode, currentServer);
            });
            
            // Autoplay toggle
            document.getElementById('autoplayToggle').addEventListener('change', function() {
                autoplayEnabled = this.checked;
                localStorage.setItem('autoplayEnabled', autoplayEnabled);
            });
            
            // Auto Next button
            document.getElementById('autoNextBtn').addEventListener('click', function() {
                autoNextEnabled = !autoNextEnabled;
                this.classList.toggle('active');
                localStorage.setItem('autoNextEnabled', autoNextEnabled);
            });
            
            // Previous episode button
            document.getElementById('prevEpisodeBtn').addEventListener('click', function() {
                if (currentEpisode > 1) {
                    navigateToEpisode(currentEpisode - 1, currentServer);
                }
            });
            
            // Next episode button
            document.getElementById('nextEpisodeBtn').addEventListener('click', function() {
                if (currentAnime && currentEpisode < currentAnime.episodes) {
                    navigateToEpisode(currentEpisode + 1, currentServer);
                }
            });
            
            // Episode range select
            document.getElementById('episodeRangeSelect').addEventListener('change', function() {
                const [start, end] = this.value.split('-').map(Number);
                generateEpisodeGrid(start, end);
            });
            
            // Episode filter
            document.getElementById('filterEpisodes').addEventListener('input', function() {
                const filterText = this.value.trim();
                filterEpisodes(filterText);
            });
            
            // View buttons (list/grid)
            document.getElementById('viewListBtn').addEventListener('click', function() {
                const grid = document.getElementById('episodeGrid');
                grid.style.gridTemplateColumns = 'repeat(2, 1fr)';
            });
            
            document.getElementById('viewGridBtn').addEventListener('click', function() {
                const grid = document.getElementById('episodeGrid');
                
                if (window.innerWidth >= 640) {
                    grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(45px, 1fr))';
                } else {
                    grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(40px, 1fr))';
                }
            });
            
            // Server selector
            document.getElementById('serverSelector').addEventListener('change', function() {
                currentServer = parseInt(this.value);
                if (player) {
                    loadEpisodeVideo(currentEpisode, currentServer);
                }
                
                // Update URL without reloading page
                const url = new URL(window.location);
                url.searchParams.set('server', currentServer);
                window.history.pushState({}, '', url);
            });
            
            // Download buttons
            document.getElementById('episodeDownloadBtn').addEventListener('click', function() {
                downloadCurrentEpisode();
            });
            
            document.getElementById('downloadButton').addEventListener('click', function() {
                downloadCurrentEpisode();
            });
            
            // Share buttons
            document.getElementById('episodeShareBtn').addEventListener('click', function() {
                shareEpisode();
            });
            
            document.getElementById('shareButton').addEventListener('click', function() {
                shareEpisode();
            });
        }

        // Initialize video player
        function initializeVideoPlayer() {
            player = new Plyr('#player', {
                controls: [
                    'play-large', 'play', 'progress', 'current-time', 'mute',
                    'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                ],
                settings: ['captions', 'quality', 'speed', 'loop'],
                keyboard: { focused: true, global: true }
            });
            
            // Handle auto-next when video ends
            player.on('ended', function() {
                if (autoNextEnabled && currentAnime && currentEpisode < currentAnime.episodes) {
                    navigateToEpisode(currentEpisode + 1, currentServer);
                }
            });
            
            // Update video duration
            player.on('loadedmetadata', function() {
                const duration = player.duration;
                const minutes = Math.floor(duration / 60);
                const seconds = Math.floor(duration % 60);
                document.getElementById('videoDuration').textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            });
            
            // Handle errors
            player.on('error', function() {
                console.error('Video playback error. Trying fallback server...');
                
                // Try alternate server if current one fails
                if (currentServer === 1 && hasServer2Source(currentEpisode)) {
                    currentServer = 2;
                    document.getElementById('serverSelector').value = '2';
                    loadEpisodeVideo(currentEpisode, currentServer);
                    
                    // Show notification
                    showNotification('Server 1 failed. Switching to Server 2...');
                }
            });
        }
        
        // Check if episode has server2 source
        function hasServer2Source(episodeNumber) {
            const episode = allEpisodes.find(ep => ep.episodeNumber === episodeNumber);
            return episode && episode.sources && episode.sources.server2;
        }
        
        // Show notification message
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition transform translate-y-0';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Load episode video
        function loadEpisodeVideo(episodeNumber, serverNumber) {
            if (!currentAnime) return;
            
            const videoUrl = `/api/animes/${currentAnime.id}/episodes/${episodeNumber}/server/${serverNumber}`;
            
            // Update video source
            if (player) {
                // Show loading indicator
                player.poster = currentAnime.poster || '/api/placeholder/800/450';
                
                player.source = {
                    type: 'video',
                    sources: [
                        {
                            src: videoUrl,
                            type: 'video/mp4'
                        }
                    ]
                };
                
                // Autoplay if enabled
                if (autoplayEnabled) {
                    setTimeout(() => player.play(), 300);
                }
            } else {
                // If player not initialized yet
                document.getElementById('videoSource').src = videoUrl;
            }
            
            // Update episode info
            updateEpisodeInfo(episodeNumber);
        }

        // Navigate to episode
        function navigateToEpisode(episodeNumber, serverNumber) {
            // Update current episode
            currentEpisode = episodeNumber;
            
            // Update URL without reloading page
            const url = new URL(window.location);
            url.searchParams.set('ep', episodeNumber);
            url.searchParams.set('server', serverNumber);
            window.history.pushState({}, '', url);
            
            // Update document title
            if (currentAnime) {
                document.title = `${currentAnime.title} - Episode ${episodeNumber} - Anime Tagalog`;
            }
            
            // Load the video
            loadEpisodeVideo(episodeNumber, serverNumber);
            
            // Check if the episode is in the current range
            const select = document.getElementById('episodeRangeSelect');
            const [start, end] = select.value.split('-').map(Number);
            
            if (episodeNumber < start || episodeNumber > end) {
                // Need to update the range
                setSelectedRange(episodeNumber);
                const option = select.options[select.selectedIndex];
                const [newStart, newEnd] = option.value.split('-').map(Number);
                generateEpisodeGrid(newStart, newEnd);
            } else {
                // Just update the active button
                updateEpisodeGridSelection();
            }
        }

        // Generate episode grid
        function generateEpisodeGrid(start, end) {
            const grid = document.getElementById('episodeGrid');
            grid.innerHTML = '';
            
            // Make sure we don't exceed the total episodes
            const totalEpisodes = currentAnime ? (currentAnime.episodes || 0) : 0;
            const actualEnd = Math.min(end, totalEpisodes);
            
            if (totalEpisodes === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-4 text-gray-500">No episodes available</div>';
                return;
            }
            
            for (let i = start; i <= actualEnd; i++) {
                const button = document.createElement('button');
                button.className = 'episode-btn';
                button.textContent = i;
                
                // Check if episode has available sources
                const episode = allEpisodes.find(ep => ep.episodeNumber === i);
                const hasSource = episode && episode.sources && (episode.sources.server1 || episode.sources.server2);
                
                if (!hasSource) {
                    button.classList.add('opacity-50');
                }
                
                // Mark current episode
                if (i === currentEpisode) {
                    button.classList.add('active');
                }
                
                // Handle click
                button.addEventListener('click', function() {
                    if (hasSource) {
                        navigateToEpisode(i, currentServer);
                    } else {
                        showNotification('This episode is not available yet');
                    }
                });
                
                grid.appendChild(button);
            }
        }

        // Update episode grid selection
        function updateEpisodeGridSelection() {
            const buttons = document.querySelectorAll('.episode-btn');
            buttons.forEach(button => {
                const episodeNum = parseInt(button.textContent);
                if (episodeNum === currentEpisode) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        // Filter episodes
        function filterEpisodes(filterText) {
            if (!filterText) {
                // Show all episodes
                document.querySelectorAll('.episode-btn').forEach(btn => {
                    btn.style.display = '';
                });
                return;
            }
            
            // Filter by number
            const filterNum = parseInt(filterText);
            document.querySelectorAll('.episode-btn').forEach(btn => {
                const btnNum = parseInt(btn.textContent);
                if (isNaN(filterNum) || btnNum.toString().includes(filterText)) {
                    btn.style.display = '';
                } else {
                    btn.style.display = 'none';
                }
            });
        }
        
        // Download current episode
        function downloadCurrentEpisode() {
            if (!currentAnime || !allEpisodes) return;
            
            const episode = allEpisodes.find(ep => ep.episodeNumber === currentEpisode);
            if (!episode || !episode.sources) {
                showNotification('No download source available');
                return;
            }
            
            // Get source URL
            const sourceUrl = episode.sources[`server${currentServer}`];
            if (!sourceUrl) {
                showNotification(`No source available for Server ${currentServer}`);
                return;
            }
            
            // Create a temporary anchor element to trigger download
            const link = document.createElement('a');
            link.href = sourceUrl;
            link.download = `${currentAnime.title} - Episode ${currentEpisode}.mp4`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Share episode
        function shareEpisode() {
            if (!currentAnime) return;
            
            // Create share URL
            const shareUrl = window.location.href;
            const shareTitle = `${currentAnime.title} - Episode ${currentEpisode} - Anime Tagalog`;
            
            // Use Web Share API if available
            if (navigator.share) {
                navigator.share({
                    title: shareTitle,
                    url: shareUrl
                }).catch(error => {
                    console.error('Error sharing:', error);
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showNotification('Link copied to clipboard!');
                }).catch(error => {
                    console.error('Failed to copy:', error);
                    showNotification('Failed to copy link');
                });
            }
        }

        // Show error message
        function showError(message) {
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="mt-6 p-4 bg-white shadow-sm rounded-lg">
                    <div class="flex flex-col items-center p-6 text-center">
                        <i data-feather="alert-circle" class="text-red-500 h-12 w-12 mb-4"></i>
                        <h3 class="text-lg font-medium text-red-800 mb-2">Error</h3>
                        <p class="text-gray-600 mb-4">${message}</p>
                        <a href="index.html" class="px-4 py-2 bg-indigo-600 text-white rounded-md">
                            Return to Home
                        </a>
                    </div>
                </div>
            `;
            feather.replace();
        }
    </script>
</body>
</html>
