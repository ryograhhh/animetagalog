<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Tagalog</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f5fa;
        }
        .anime-card {
            transition: transform 0.2s ease;
        }
        .anime-card:hover {
            transform: translateY(-4px);
        }
        .tab-active {
            background-color: #e8e6ff;
            color: #5046e5;
            font-weight: 600;
        }
        .tab {
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .tab:hover:not(.tab-active) {
            background-color: #f0f0f0;
        }
        .pagination-button {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            background-color: #ffffff;
            color: #333;
            transition: all 0.2s ease;
        }
        .pagination-button:hover {
            background-color: #f0f0f0;
        }
        .pagination-active {
            background-color: #f8f8f8;
            font-weight: 600;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 999;
        }
        .skeleton {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .status-dot {
            width: 10px;
            height: 10px;
            background-color: #64dd17;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="pb-20">
    <!-- Top Navigation -->
    <nav class="bg-white py-3 px-4 shadow-sm">
        <div class="container mx-auto flex justify-between items-center">
            <a href="index.html" class="text-xl font-bold text-indigo-600 flex items-center">
                <i data-feather="play-circle" class="mr-2"></i>
                Anime Tagalog
            </a>
            <div class="flex items-center">
                <div class="relative md:w-64 mr-3">
                    <input type="text" placeholder="Search anime..." id="searchInput" 
                        class="w-full bg-gray-100 px-4 py-2 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <i data-feather="search" class="absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"></i>
                </div>
                <a href="admin.html" class="text-gray-500 hover:text-indigo-600">
                    <i data-feather="settings" class="h-5 w-5"></i>
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 mt-4">
        <!-- Tabs and Pagination -->
        <div class="flex justify-between mb-4">
            <!-- Category Tabs -->
            <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                <button class="tab tab-active" data-tab="newest">NEWEST</button>
                <button class="tab" data-tab="popular">POPULAR</button>
                <button class="tab" data-tab="top-rated">TOP RATED</button>
            </div>
            
            <!-- Pagination -->
            <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                <button class="pagination-button" id="prevPage">
                    <i data-feather="chevron-left" class="h-4 w-4"></i>
                </button>
                <button class="pagination-button pagination-active" id="currentPage">1</button>
                <button class="pagination-button" id="nextPage">
                    <i data-feather="chevron-right" class="h-4 w-4"></i>
                </button>
            </div>
        </div>

        <!-- Anime Grid -->
        <div id="animeGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
            <!-- Loading skeletons -->
            <div class="skeleton bg-white rounded-lg h-64"></div>
            <div class="skeleton bg-white rounded-lg h-64"></div>
            <div class="skeleton bg-white rounded-lg h-64"></div>
            <div class="skeleton bg-white rounded-lg h-64"></div>
            <div class="skeleton bg-white rounded-lg h-64"></div>
            <div class="skeleton bg-white rounded-lg h-64"></div>
            <div class="skeleton bg-white rounded-lg h-64"></div>
            <div class="skeleton bg-white rounded-lg h-64"></div>
            <div class="skeleton bg-white rounded-lg h-64"></div>
            <div class="skeleton bg-white rounded-lg h-64"></div>
            <div class="skeleton bg-white rounded-lg h-64"></div>
            <div class="skeleton bg-white rounded-lg h-64"></div>
        </div>

        <!-- Search Results Section (Hidden by default) -->
        <section id="searchResults" class="mt-4 hidden">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-medium text-gray-800 flex items-center">
                    <i data-feather="search" class="mr-2 h-4 w-4"></i> Search Results
                </h2>
                <button id="clearSearch" class="text-sm text-indigo-600 hover:text-indigo-800 flex items-center">
                    <i data-feather="x" class="mr-1 h-4 w-4"></i> Clear
                </button>
            </div>
            <div id="searchResultsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                <!-- Search results will be loaded here -->
            </div>
        </section>
    </div>

    <!-- Bottom Navigation Bar (Mobile) -->
    <div class="bottom-nav py-2 px-4 md:hidden">
        <div class="flex justify-between items-center">
            <a href="index.html" class="flex flex-col items-center text-indigo-600">
                <i data-feather="home" class="h-6 w-6"></i>
                <span class="text-xs mt-1">Home</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-500">
                <i data-feather="trending-up" class="h-6 w-6"></i>
                <span class="text-xs mt-1">Trending</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-500">
                <i data-feather="calendar" class="h-6 w-6"></i>
                <span class="text-xs mt-1">Schedule</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-500">
                <i data-feather="clock" class="h-6 w-6"></i>
                <span class="text-xs mt-1">History</span>
            </a>
            <a href="#" class="flex flex-col items-center text-gray-500">
                <i data-feather="user" class="h-6 w-6"></i>
                <span class="text-xs mt-1">Profile</span>
            </a>
        </div>
    </div>

    <script>
        // Global variables
        let currentTab = 'newest';
        let currentPage = 1;
        let totalPages = 1;
        let allAnimes = [];
        let itemsPerPage = 12;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            loadAnimes();
            setupEventListeners();
            
            // Check for search parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const searchTerm = urlParams.get('search');
            if (searchTerm) {
                document.getElementById('searchInput').value = searchTerm;
                searchAnimes(searchTerm);
            }
            
            // Adjust items per page based on screen size
            adjustItemsPerPage();
            window.addEventListener('resize', adjustItemsPerPage);
        });

        // Adjust items per page based on screen size
        function adjustItemsPerPage() {
            if (window.innerWidth < 640) {
                itemsPerPage = 6; // Mobile: 2 columns x 3 rows
            } else if (window.innerWidth < 768) {
                itemsPerPage = 9; // Small tablets: 3 columns x 3 rows
            } else if (window.innerWidth < 1024) {
                itemsPerPage = 12; // Tablets: 4 columns x 3 rows
            } else {
                itemsPerPage = 18; // Desktop: 6 columns x 3 rows
            }
            
            if (allAnimes.length > 0) {
                renderAnimesByTab(currentTab);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    setActiveTab(tabName);
                    currentPage = 1;
                    updatePaginationDisplay();
                    renderAnimesByTab(tabName);
                });
            });
            
            // Search input
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    const searchTerm = this.value.trim();
                    if (searchTerm.length > 0) {
                        searchAnimes(searchTerm);
                    }
                }
            });
            
            // Clear search
            document.getElementById('clearSearch').addEventListener('click', function() {
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').classList.add('hidden');
                
                // Update URL without reloading the page
                const url = new URL(window.location);
                url.searchParams.delete('search');
                window.history.pushState({}, '', url);
            });
            
            // Pagination
            document.getElementById('prevPage').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    updatePaginationDisplay();
                    renderAnimesByTab(currentTab);
                    window.scrollTo(0, 0);
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    updatePaginationDisplay();
                    renderAnimesByTab(currentTab);
                    window.scrollTo(0, 0);
                }
            });
        }

        // Set active tab
        function setActiveTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.remove('tab-active');
                }
            });
            currentTab = tabName;
        }

        // Update pagination display
        function updatePaginationDisplay() {
            document.getElementById('currentPage').textContent = currentPage;
            
            // Disable/enable prev/next buttons
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');
            
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
            
            prevButton.style.opacity = prevButton.disabled ? 0.5 : 1;
            nextButton.style.opacity = nextButton.disabled ? 0.5 : 1;
        }

        // Load animes from API
        function loadAnimes() {
            fetch('/api/animes')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    allAnimes = data;
                    renderAnimesByTab(currentTab);
                })
                .catch(error => {
                    console.error('Error loading animes:', error);
                    showErrorMessage('Failed to load anime data. Please try again later.');
                });
        }

        // Render animes based on selected tab
        function renderAnimesByTab(tabName) {
            if (!allAnimes || allAnimes.length === 0) {
                return showNoAnimesMessage();
            }
            
            let displayAnimes = [];
            
            switch (tabName) {
                case 'newest':
                    displayAnimes = [...allAnimes].sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
                    break;
                case 'popular':
                    displayAnimes = [...allAnimes].sort((a, b) => {
                        const popularityA = (b.views || 0) + (b.rating || 0) * 100;
                        const popularityB = (a.views || 0) + (a.rating || 0) * 100;
                        return popularityA - popularityB;
                    });
                    break;
                case 'top-rated':
                    displayAnimes = [...allAnimes].sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                default:
                    displayAnimes = [...allAnimes];
            }
            
            // Calculate total pages
            totalPages = Math.ceil(displayAnimes.length / itemsPerPage);
            
            // Update pagination
            updatePaginationDisplay();
            
            // Get current page items
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageItems = displayAnimes.slice(startIndex, endIndex);
            
            // Render items
            renderAnimeCards(pageItems);
        }

        // Render anime cards to container
        function renderAnimeCards(animes, targetContainer = 'animeGrid') {
            const container = document.getElementById(targetContainer);
            container.innerHTML = '';
            
            if (!animes || animes.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-8">
                        <i data-feather="film-off" class="mb-2 text-gray-400 h-10 w-10"></i>
                        <p class="text-gray-500">No anime found</p>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            animes.forEach(anime => {
                container.appendChild(createAnimeCard(anime));
            });
            
            feather.replace();
        }

        // Create anime card
        function createAnimeCard(anime) {
            const card = document.createElement('div');
            card.className = 'anime-card bg-white rounded-lg overflow-hidden shadow-sm';
            
            const poster = anime.poster || '/api/placeholder/180/240';
            const title = anime.title || 'Unknown Title';
            const episodes = anime.episodes || 0;
            const year = anime.year || new Date().getFullYear();
            
            // Determine type badge (TV, ONA, etc.)
            const type = anime.type || 'TV';
            
            // Determine episode or chapter count
            const epCount = anime.currentEpisode || episodes;
            const epTotal = episodes || '?';
            const epDisplay = `${epCount} / ${epTotal}`;
            
            // Check if it has CC/subs
            const hasSubs = anime.hasSubs || true;
            const subIcon = hasSubs ? '<i data-feather="message-square" class="h-3 w-3"></i>' : '';
            
            // Check if it has audio
            const hasAudio = anime.hasAudio || true;
            const audioIcon = hasAudio ? '<i data-feather="mic" class="h-3 w-3"></i>' : '';
            
            card.innerHTML = `
                <a href="watch.html?id=${anime.id}">
                    <!-- Poster Image -->
                    <div class="relative">
                        <img src="${poster}" alt="${title}" class="w-full h-40 sm:h-44 object-cover">
                    </div>
                    
                    <!-- Title and Info -->
                    <div class="p-2">
                        <!-- Title with status dot -->
                        <div class="flex items-center">
                            <span class="status-dot"></span>
                            <h3 class="text-sm font-medium text-gray-800 truncate-2">${title}</h3>
                        </div>
                        
                        <!-- Info badges -->
                        <div class="flex flex-wrap mt-2 gap-1">
                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">${type}</span>
                            <span class="text-xs bg-gray-200 px-2 py-1 rounded">${year}</span>
                            <span class="text-xs bg-gray-200 px-2 py-1 rounded flex items-center gap-1">
                                ${subIcon} ${hasSubs ? 'CC' : ''} ${epDisplay}
                            </span>
                        </div>
                    </div>
                </a>
            `;
            
            return card;
        }

        // Show error message
        function showErrorMessage(message) {
            const container = document.getElementById('animeGrid');
            container.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-8 bg-red-50 rounded-lg">
                    <i data-feather="alert-circle" class="mb-2 text-red-500 h-10 w-10"></i>
                    <p class="text-red-600">${message}</p>
                    <button class="mt-3 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" onclick="loadAnimes()">
                        Retry
                    </button>
                </div>
            `;
            feather.replace();
        }

        // Show no animes message
        function showNoAnimesMessage() {
            const container = document.getElementById('animeGrid');
            container.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-8">
                    <i data-feather="film-off" class="mb-2 text-gray-400 h-10 w-10"></i>
                    <p class="text-gray-500">No anime added yet</p>
                </div>
            `;
            feather.replace();
        }

        // Search animes
        function searchAnimes(searchTerm) {
            fetch(`/api/animes/search?q=${encodeURIComponent(searchTerm)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const resultsSection = document.getElementById('searchResults');
                    const resultsContainer = document.getElementById('searchResultsContainer');
                    
                    resultsContainer.innerHTML = '';
                    
                    if (data.length === 0) {
                        resultsContainer.innerHTML = `
                            <div class="col-span-full flex flex-col items-center justify-center py-8">
                                <i data-feather="search" class="mb-2 text-gray-400 h-10 w-10"></i>
                                <p class="text-gray-500">No results found for "${searchTerm}"</p>
                            </div>
                        `;
                    } else {
                        renderAnimeCards(data, 'searchResultsContainer');
                    }
                    
                    resultsSection.classList.remove('hidden');
                    feather.replace();
                    
                    // Update URL without reloading the page
                    const url = new URL(window.location);
                    url.searchParams.set('search', searchTerm);
                    window.history.pushState({}, '', url);
                })
                .catch(error => {
                    console.error('Error searching animes:', error);
                    const resultsSection = document.getElementById('searchResults');
                    const resultsContainer = document.getElementById('searchResultsContainer');
                    
                    resultsContainer.innerHTML = `
                        <div class="col-span-full flex flex-col items-center justify-center py-8">
                            <i data-feather="alert-circle" class="mb-2 text-red-500 h-10 w-10"></i>
                            <p class="text-red-600">Failed to search. Please try again later.</p>
                        </div>
                    `;
                    
                    resultsSection.classList.remove('hidden');
                    feather.replace();
                });
        }
    </script>
</body>
</html>
